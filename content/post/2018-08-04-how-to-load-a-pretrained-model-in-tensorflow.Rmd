---
title: How to load a pretrained model in TensorFlow
author: Collin Erickson
date: '2018-08-04'
slug: how-to-load-a-pretrained-model-in-tensorflow
categories: []
tags: [TensorFlow]
---

At I struggled for days to load a pretrained model into
TensorFlow before giving up.
Then a few weeks later I tried again and it worked fine.
I'm going to try to do it again here to make sure
I can get it to work.

## Why you would use a pretrained model

Pretrained models are especially useful for image classification.
The convolutional neural networks (CNNs) used for image classification
often have eight or more layers and over a million parameters.
To train this large a network you need a massive dataset
and a lot of time to train the network.
I don't have these kinds of resources,
but I can use a pretrained model and adapt to my needs.
The lower levels of a CNN are generally just finding
edges, lines, and basic shapes, regardless of what the
images are that are given as input.
Thus it would be a waste of my time to redo training of
these basic concepts when I can use a pretrained network
and just change the higher layers.

```{python}
import tensorflow as tf
```

```{python}
print(tf.__version__)
```

## How to save and load models in TensorFlow

They have a guide on how to save and load models
[here](https://www.tensorflow.org/guide/saved_model),
and a guide on how to export and import MetaGraphs
[here](https://www.tensorflow.org/api_guides/python/meta_graph).


However, TensorFlow has terrible documentation on how to get
pretrained models working.
They have a list of pretrained models
[here](https://github.com/tensorflow/models/tree/master/research/slim).
If you just have your images in folders for each label,
then it looks like it should be pretty easy to use these models.
However, I want to do a more hands-on approach.


## Loading resnet

I'm going to follow the Stack Overflow question from
[here](https://stackoverflow.com/questions/39969751/how-to-load-pre-trained-tensorflow-model-named-inception-by-google/43677411).
First I download the 
[inception_resnet_v2.py file](https://github.com/tensorflow/models/blob/master/research/slim/nets/inception_resnet_v2.py).
This file allows us to load the network structure into TF.
If it's not in the same path as your current path,
you need to add its folder to your path.

```{python}
import sys
sys.path.insert(0, 'C://Users//cbe117//Documents//GitHub//website-hugo//static//post//2018-08-04-how-to-load-a-pretrained-model-in-tensorflow')
from inception_resnet_v2 import inception_resnet_v2, inception_resnet_v2_arg_scope
```


```{python}
print(inception_resnet_v2)
```

```{python}
#import tensorflow as tf
slim = tf.contrib.slim
```


The model was trained with images that were 299 by 299
with three channels for colors, and to predict which class each
images out of 1001 classes.
We can load the model structure with the following:

```{python}
height = 299
width = 299
channels = 3

X = tf.placeholder(tf.float32, shape=[None, height, width, channels])
with slim.arg_scope(inception_resnet_v2_arg_scope()):
     logits, end_points = inception_resnet_v2(X, num_classes=1001,is_training=False)
```


Next we can load the saved weights from the pretrained model.
You can download the weights from 
[here](https://github.com/tensorflow/models/tree/master/research/slim),
picking [inception_resnet_v2_2016_08_30.tar.gz](http://download.tensorflow.org/models/inception_resnet_v2_2016_08_30.tar.gz).

This loads the network weights.

```{python}
saver = tf.train.Saver()
sess = tf.Session()
saver.restore(sess, "C://Users/cbe117/Documents/GitHub/website-hugo/static/post/2018-08-04-how-to-load-a-pretrained-model-in-tensorflow/inception_resnet_v2_2016_08_30.ckpt")
```


Now if I try a cat picture.
Here's the class it predicts.

http://images.mentalfloss.com/sites/default/files/styles/mf_image_16x9/public/501389-iStock-507640348.jpg?itok=8bHyCd5-&resize=1100x1100
```{python}
import matplotlib.pyplot as plt
cat = plt.imread('C://Users//cbe117//Documents//GitHub//website-hugo//static//post//2018-08-04-how-to-load-a-pretrained-model-in-tensorflow//cat299.jpg')
#plt.imshow(cat)
```

This is what the cat looks like:

```{r}
knitr::include_graphics('C://Users//cbe117//Documents//GitHub//website-hugo//static//post//2018-08-04-how-to-load-a-pretrained-model-in-tensorflow//cat299.jpg')
#rcat <- imager::load.image(('C://Users//cbe117//Documents//GitHub//website-hugo//static//post//2018-08-04-how-to-load-a-pretrained-model-in-tensorflow//cat.jpg'))
#plot(rcat)
```

<!-- ```{python} -->
<!-- #import cv2 -->
<!-- #cat2 = cv2.imread('C://Users//cbe117//Documents//GitHub//website-hugo//static//post//2018-08-04-how-to-load-a-pretrained-model-in-tensorflow//cat.jpg') -->
<!-- #cv2.imshow(cat2) -->
<!-- ``` -->


<!-- The input must be 299 by 299: -->

<!-- ```{python} -->
<!-- cat299 = cat[500:800, 200:500] -->
<!-- ``` -->

```{python}
catlogits = sess.run(logits, feed_dict={X:cat.reshape(1,299,299,3)})
print(catlogits.shape)
print(catlogits)
```

```{python}
import numpy as np
print(np.sort(catlogits[0,:])[-5:])
print(np.argsort(catlogits[0,:])[-5:])
```


To figure out which classes these are, we need a lookup table for our network.
It can be found [here](https://gist.github.com/yrevar/942d3a0ac09ec9e5eb3a).
Here I'll create a list with the class names from this file.
Note that the first class should be an unknown class, so we need to add one to the front.

```{python}
with open("C://Users//cbe117//Documents//GitHub//website-hugo//static//post//2018-08-04-how-to-load-a-pretrained-model-in-tensorflow//imagenet1000_clsid_to_human.txt", "r") as file:
    lines = [line for line in file]
linesclean = [line.strip().replace("'",'').replace('{','').replace('}','') for line in lines]
linesclean2 = [line.split(":")[1].strip().replace("",'') for line in linesclean]
classes = ["unknown"] + linesclean2
print(len(classes))
print(classes[0:10])
```

Now we can see what the predicted classes were.

```{python}
# 5 most likely classes, most likely is last
print([classes[i] for i in np.argsort(catlogits[0,:])[-5:]])
```

The most likely class according to the prediction is comic book.
This is really bad.
After some more searching online, I figured out
[the problem](https://stackoverflow.com/questions/39582703/using-pre-trained-inception-resnet-v2-with-tensorflow).
The inputs of Resnet should be preprocessed to be in range -1 to 1,
not 0 to 255.

```{python}
def preprocess_input(x): 
   x = np.divide(x, 255.0) 
   x = np.subtract(x, 0.5) 
   x = np.multiply(x, 2.0) 
   return x
   
catlogits2= sess.run(logits, feed_dict={X:preprocess_input(cat.reshape(1,299,299,3))})
print([classes[i] for i in np.argsort(catlogits2[0,:])[-5:]])
```

Now it looks right.
The top five classes are all cats, with the most likely class a tabby cat,
which looks right to me.

Also since the top logit is so much larger than the others,
it is essentially a prediction with 100% confidence.
To get probabilities from logits, we would need to take the exponential
of each and divide by the sum of all these exponentials.

```{python}
np.sort(catlogits[0,:])
```


catb
https://www.catster.com/wp-content/uploads/2018/07/Savannah-cat-long-body-shot.jpg

